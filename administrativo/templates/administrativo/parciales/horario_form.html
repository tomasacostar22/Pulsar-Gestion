{% if horario %}
  {% if mensaje %}
    <div class="bg-green-50 border border-green-200 text-green-700 text-sm px-4 py-3 rounded-lg mb-4">
      {{ mensaje }}
    </div>
  {% endif %}

  <form method="post" action="{% url 'administrativo:horarios' %}?empleado={{ empleado_id }}">
    {% csrf_token %}
    <div class="bg-white rounded-xl border border-indigo-100 shadow-sm overflow-hidden">
      <table class="w-full">
        <thead>
          <tr class="bg-indigo-50 text-indigo-700 text-sm font-medium">
            <th class="px-5 py-3 text-left">Dia</th>
            <th class="px-5 py-3 text-left">Entrada</th>
            <th class="px-5 py-3 text-left">Salida</th>
            <th class="px-5 py-3 text-left">Horas</th>
          </tr>
        </thead>
        <tbody id="horario-tabla">
          {% for dia_key, dia_nombre, tiempos in dias_horario %}
            <tr class="border-t border-indigo-50">
              <td class="px-5 py-3 text-sm font-medium text-indigo-900">{{ dia_nombre }}</td>
              <td class="px-5 py-3">
                <input
                  type="time"
                  name="{{ dia_key }}_entrada"
                  value="{{ tiempos.0|time:'H:i' }}"
                  class="hora-input px-3 py-1.5 text-sm border border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent transition"
                  data-dia="{{ dia_key }}"
                  data-tipo="entrada"
                >
              </td>
              <td class="px-5 py-3">
                <input
                  type="time"
                  name="{{ dia_key }}_salida"
                  value="{{ tiempos.1|time:'H:i' }}"
                  class="hora-input px-3 py-1.5 text-sm border border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent transition"
                  data-dia="{{ dia_key }}"
                  data-tipo="salida"
                >
              </td>
              <td class="px-5 py-3 text-sm text-indigo-600 horas-dia" data-dia="{{ dia_key }}">--</td>
            </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr class="border-t-2 border-indigo-200 bg-indigo-50/50">
            <td colspan="3" class="px-5 py-3 text-sm font-bold text-indigo-900">Total horas semanales</td>
            <td class="px-5 py-3 text-sm font-bold text-indigo-700" id="total-horas">{{ horario.total_horas_semana }}</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <button
      type="submit"
      class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium px-6 py-2.5 rounded-lg transition cursor-pointer"
    >
      Guardar horario
    </button>
  </form>

  <script>
    (function() {
      function calcularHoras() {
        const dias = [...new Set([...document.querySelectorAll('.hora-input')].map(i => i.dataset.dia))];
        let totalMin = 0;

        dias.forEach(dia => {
          const entrada = document.querySelector(`[name="${dia}_entrada"]`).value;
          const salida = document.querySelector(`[name="${dia}_salida"]`).value;
          const celda = document.querySelector(`.horas-dia[data-dia="${dia}"]`);

          if (entrada && salida) {
            const [eh, em] = entrada.split(':').map(Number);
            const [sh, sm] = salida.split(':').map(Number);
            const diff = (sh * 60 + sm) - (eh * 60 + em);
            if (diff > 0) {
              const h = Math.floor(diff / 60);
              const m = diff % 60;
              celda.textContent = m ? `${h}h ${m}m` : `${h}h`;
              totalMin += diff;
            } else {
              celda.textContent = '--';
            }
          } else {
            celda.textContent = '--';
          }
        });

        const th = Math.floor(totalMin / 60);
        const tm = totalMin % 60;
        document.getElementById('total-horas').textContent = tm ? `${th}h ${tm}m` : `${th}h`;
      }

      document.querySelectorAll('.hora-input').forEach(input => {
        input.addEventListener('change', calcularHoras);
      });

      calcularHoras();
    })();
  </script>

{% elif empleado_id %}
  <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 text-sm px-4 py-3 rounded-lg">
    Empleado no encontrado.
  </div>
{% else %}
  <div class="bg-indigo-50 border border-indigo-100 text-indigo-600 text-sm px-4 py-3 rounded-lg">
    Selecciona un empleado para ver y editar su horario laboral.
  </div>
{% endif %}
